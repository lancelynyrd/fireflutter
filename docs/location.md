# 위치, 위치 기반 검색


- 현재 FireFlutter 에서 지원하는 위치 기반 검색은 공식 문서에서 제공하는 [Firebase 의 Geo Query](https://firebase.google.com/docs/firestore/solutions/geoqueries?hl=ko)를 부분적으로 지원한다. 히지만 검색 결과의 정확도를 높이기 위해서 불편한 계산을 함에도 불구하고 결과가 정확하지 않다.

- 만약, 위치 기반 검색 결과에 오차가 있어도 괜찮다면, Geo hash 를 DB 에 저장해 놓고, 검색을 해도 된다.
  - 그리고, 1km, 2km, 5km, 10km, 20km 등과 같이 원하는 데로 거리를 필터를 할 수 있는 것이 아니라, Geo hash 의 문자열 단계에 따라서 가능한데 이 또한 불편하다.
  - 즉, 많은 것이 불편하고 오차가 있음에도 불구하고, 간단히 쓰고자 한다면 Geo Query 를 사용하면 된다.


- 모든 사용자 마다 위/경도를 DB 에 저장하면, 나의 위/경도와 비교해서 각 사용자가 나와 얼마나 떨어져 있는지 km 로 쉽게 표시 할 수 있다.

- 정확한 위치 기반 검색을 하고자 한다면 외부 데이터베이스 서비스(또는 검색 전용 서비스)를 이용하는 것이 좋은 방법이다. 왠만한 검색 기능이 있는 서비스들은 위치 기반 검색이 가능하다.

- 하지만, 외부 검색 서비스를 이용하기 싫다면 아래의 방법을 이용해 본다. 다만, 비용이 외부 검색보다 더 비싸게 들 수 있다.

- 참고로, 사용자의 정보를 외부 DB 에 mirror 해 놓는 경우, 그리고 그 외부 DB 의 속도가 느린 경우, 한 화면에서 여러 가지 옵션으로 사용자 검색을 할 때, 거리 검색 필터링을 하지 않는 경우 Firebase 데이터베이스를 이용해서 결과를 보여주고, 거리 검색 필터링이 추가되는 경우만 외부 DB 를 써도 되겠다.



## 위치 기반 거리 검색

- 나와 상대방의 lat/lon 값이 있으면 몇 km 가 떨어져 있는지 알 수 있고, 또 특정 범위 내로 필터링을 할 수 있다.
- Firebase 의 서비스에는 거리 기반 필터링하는 기능이 없으므로, 클라이언트 앱에서 계산을 하면 된다.
- 참고로 Firebase 비용을 아껴야 하므로 다음과 같은 설계를 할 수 있다.


### 위치 저장
- Firebase Database 를 이용하면 좀 더 저렴하게 이용 할 수 있다.
- 각 사용자의 lat/lon 을 `lat-lon` 과 같이 해서 19 글자로 저장한다. 예: "35.123456-127.12345"
- 각 사용자의 lat/lon 을 `/user-locations/<uid>/lat-lon` 와 같이 저장한다.

### 거리 필터링

- 앱이 시작 할 때, `onChildAdded` 이벤트로 모든 사용자의 lat/lon 을 가져와 lat/lon 을 파싱한다. (나와의 거리가 얼마나 떨어져 있는지 계산).  또한 `onChildAdded` 는 새로운 사용자의 lat/lon 만 추가록 계속 가져 올 수 있게 해 준다.
- `onChildAdded` 내부 함수에서 `onChildChanged` 이벤트를 사용하려 listen 한다. 즉, 사용자의 lat/lon 이 바뀌면 그 사용자의 lat/lon 만 메모리에 업데이트 한다.
- (필요한 경우) 나의 위치가 변경이 될 수 있으니, 10분에 한번씩 나의 lat/lon 으로 다른 사용자들과의 lat/lon 거리 비교를 다시 계산한다.
- 검색 목록에서 거리 필터링을 하면, 해당 거리 내에 있는 사용자들만 보여주면 된다.
- 만약, 앱 내에서 거리 필티링 외에 여러 가지 필드를 추가로 필터링을 한다면, 앱내에서 적절한 처리를 해 주어야 할 것이다.

### 비용 계산

아래의 비용은 대략적인 비용이며, 실제로는 이 보다 더 많은 비용이 지출 될 수 있다.

- 앱이 사용자의 lat/lon 정보를 가져 올 때, (각종 키 정보 포함) 한 명당 30 바이트 데이터 크기를 가져온다고 가정하면,

- 앱의 규모가 작은 경우, 예를 들면
  - 전체 사용자 1 만명
  - 매일 활동 사용자 500 명인 경우
  - 10000 * 500 * 30 = 하루 150,000,000 바이트 = 하루 0.15 달러

- 앱의 규모가 큰 경우, 예를 들면,
  - 전체 사용자 10 만명
  - 매일 활동 사용자 2,000 명인 경우,
  - 100000 * 2000 * 30 = 하루 6,000,000,000 바이트 = 하루 6 달러
